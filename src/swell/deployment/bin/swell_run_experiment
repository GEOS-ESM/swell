#!/bin/sh

# (C) Copyright 2021-2022 United States Government as represented by the Administrator of the
# National Aeronautics and Space Administration. All Rights Reserved.
#
# This software is licensed under the terms of the Apache Licence Version 2.0
# which can be obtained at http://www.apache.org/licenses/LICENSE-2.0.

#******************************************************************************
# English Name: Deploy Experiment
# -------------
#
# Purpose: Executes a JEDI/GEOS experiment using a designated workflow engine
# --------
#
# Language: Bourne Shell
# ---------
#
# Notes: 1. This utility should be installed in the experiment suite dir.
# ------ 2. CYLC is the default workflow engine for now.
#
# Usage: swell_run_experiment [-p|--path path] [-i|--initial initial_dt]
# ------                         [-f|--final final_dt]
#
# Interface:              Type   Access  Description
# ----------                     Intent
#
#  path                    str   OPT,IN  path to suite directory for the
#                                        experiment to be executed. Default:
#                                        current directory.
#
#  initial_dt              str   OPT,IN  ISO datetime string representing
#                                        the starting cycle time.
#                                        (e.g. 2015-01-05T12)
#
#  final_dt                str   OPT,IN  ISO datetime string representing
#                                        the ending cycle time.
#                                        (e.g. 2015-01-10T00)
#
#******************************************************************************

# Functions
# =========

function iso_dt()
{

  local iso_str year month day hour

  iso_str=`echo ${1}00 | tr -d '\-:T' | sed 's/ //g'`
  year=`echo $iso_str | cut -c1-4`
  month=`echo $iso_str | cut -c5-6`
  day=`echo $iso_str | cut -c7-8`
  hour=`echo $iso_str | cut -c9-10`
  iso_str="${year}-${month}-${day}T$hour"

  echo "$iso_str"

  return 0
}

# Check Arguments
# ===============

  suite_dir=`pwd`

  while [[ $# -gt 0 ]]; do
    key="$1"

    case $key in
      -p|--path)
        suite_dir="$2"
        shift # past argument
        shift # past value
        ;;
      -i|--initial)
        initial_cycle_point="$2"
        shift # past argument
        shift # past value
        ;;
      -f|--final)
        final_cycle_point="$2"
        shift # past argument
        shift # past value
        ;;
      *)    # unknown option
        echo "Usage: $0 [-p path] [-i initial_dt] [-f final_dt]" 2>&1
        exit 1
        ;;
    esac
  done

# Derive the experiment directory and ID from the
# location of the suite directory.
# ===============================================

  suite_dir=`realpath $suite_dir`

  exproot=`dirname $suite_dir`
  expid=`basename $exproot`

# Perform sanity check: suite sub-directory
# should be in the experiment root.
# =========================================

  if [ ! -d $exproot/suite ]; then
    echo "$0: Unable to locate experiment suite"
    exit 2
  fi

# Set the suite start/end cycle times.
# ====================================

  cd $exproot/suite

  if [ -z "$initial_cycle_point" ]; then
    initial_cycle_point=`get_param experiment-filled.yaml initial_cycle_dt`
  fi

  if [ -z "$final_cycle_point" ]; then
    final_cycle_point=`get_param experiment-filled.yaml final_cycle_dt`
  fi

  initial_cycle_point=`iso_dt $initial_cycle_point`
  final_cycle_point=`iso_dt $final_cycle_point`

# Load modules to access CYLC8+
# =============================

  source $MODULESHOME/init/bash
  module purge
  module use -a /home/mathomp4/modulefiles-SLES12
  module load python/MambaCylc/8.0b1

# export DHOPT=/discover/nobackup/drholdaw/opt/
# module use -a $DHOPT/modulefiles/core
# module load miniconda/3.9-cylc

# Install the cylc suite for this experiment.
# ===========================================

  /bin/rm -r -f $exproot/cylc-run/$expid

  if [ -L "$HOME/cylc-run/$expid" ]; then
    /bin/rm -r `realpath $HOME/cylc-run/$expid`
    /bin/rm $HOME/cylc-run/$expid
  fi

  if [ -e "$HOME/cylc-run/$expid" ]; then
    echo "$0: Warning: experiment already exists" >&2
    exit 3
  fi

  if [ -f "$exproot/suite/global.cylc" ]; then
    export CYLC_CONF_PATH=$exproot/suite
  fi

  cylc install --directory=$exproot/suite --flow-name=$expid --no-run-name

  cat flow.cylc \
  | sed "s/initial.*cycle.*point.*=.*/initial cycle point = $initial_cycle_point/g" \
  | sed "s/final.*cycle.*point.*=.*/final cycle point = $final_cycle_point/g" \
  > $HOME/cylc-run/$expid/flow.cylc

# Execute the suite
# =================

  cylc play $expid
  cylc tui $expid

exit 0
