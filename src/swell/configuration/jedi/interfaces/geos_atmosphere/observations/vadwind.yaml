obs operator:
  name: VertInterp
obs space:
  name: vadwind
  obsdatain:
    engine:
      type: H5File
      obsfile: '{{cycle_dir}}/vadwind.{{window_begin}}.nc4'
    obsgrouping:
      group variables: ["stationIdentification", "datetime"]
      sort variable: "pressure"
      sort order: "descending"
  obsdataout:
    engine:
      type: H5File
      obsfile: '{{cycle_dir}}/{{experiment_id}}.vadwind.{{window_begin}}.nc4'
  simulated variables: [windEastward, windNorthward]
#--------------------------------------------------------------------------------------------------------------------
obs filters:
# Begin by assigning all ObsError to a constant value. These might get overwritten later.
- filter: BlackList
  filter variables:
  - name: windEastward
  - name: windNorthward
  action:
    name: assign error
    error parameter: 2.0             # 2.0 m/s
#
# Assign the initial ObsError, based on height/pressure
- filter: Bounds Check
  filter variables:
  - name: windEastward
  - name: windNorthward
  minvalue: -135
  maxvalue: 135
  action:
    name: assign error
    error function:
      name: ObsFunction/ObsErrorModelStepwiseLinear
      options:
        xvar:
          name: MetaData/pressure
        xvals: [100000, 95000, 85000, 80000, 70000, 65000, 60000, 55000, 50000, 45000, 40000, 35000, 30000, 25000, 20000, 15000, 10000]
        errors: [1.4, 1.5, 1.5, 1.6, 1.6, 1.8, 1.9, 2.0, 2.1, 2.3, 2.6, 2.8, 3.0, 3.2, 2.7, 2.4, 2.1]
#
# Reject all obs with PreQC mark already set above 3
- filter: PreQC
  maxvalue: 3
  action:
    name: reject
#
# Reject when pressure is less than 226 mb.
- filter: Bounds Check
  filter variables:
  - name: windEastward
  - name: windNorthward
  test variables:
  - name: MetaData/pressure
  minvalue: 22600
  action:
    name: reject
#
# Observation Range Sanity Check: either wind component or velocity exceeds 135 m/s
- filter: Bounds Check
  filter variables:
  - name: windEastward
  - name: windNorthward
  minvalue: -135
  maxvalue: 135
  action:
    name: reject
- filter: Bounds Check
  filter variables:
  - name: windEastward
  - name: windNorthward
  test variables:
  - name: ObsFunction/Velocity
  maxvalue: 135.0
  action:
    name: reject
#
# Reject when difference of wind direction is more than 50 degrees.
- filter: Bounds Check
  filter variables:
  - name: windEastward
  - name: windNorthward
  test variables:
  - name: ObsFunction/WindDirAngleDiff
  maxvalue: 50.0
  action:
    name: reject
  defer to post: true
#
# Inflate obserror when multiple obs exist inside vertical model layers.
- filter: BlackList
  filter variables:
  - name: windEastward
  action:
    name: inflate error
    inflation variable:
      name: ObsFunction/ObsErrorFactorConventional
      options:
        test QCflag: PreQC
        inflate variables: [eastward_wind]
  defer to post: true
#
- filter: BlackList
  filter variables:
  - name: windNorthward
  action:
    name: inflate error
    inflation variable:
      name: ObsFunction/ObsErrorFactorConventional
      options:
        test QCflag: PreQC
        inflate variables: [northward_wind]
  defer to post: true
#
- filter: Background Check
  filter variables:
  - name: windEastward
  - name: windNorthward
  absolute threshold: 7.5
  action:
    name: inflate error
    inflation factor: 2.5
  defer to post: true
#
# If the total inflation factor is too big, reject.
- filter: Bounds Check
  filter variables:
  - name: windEastward
  action:
    name: reject
  maxvalue: 6.5
  test variables:
  - name: ObsFunction/ObsErrorFactorQuotient
    options:
      numerator:
        name: ObsErrorData/windEastward   # After inflation step
      denominator:
        name: ObsError/windEastward
  defer to post: true
#
- filter: Bounds Check
  filter variables:
  - name: windNorthward
  action:
    name: reject
  maxvalue: 6.5
  test variables:
  - name: ObsFunction/ObsErrorFactorQuotient
    options:
      numerator:
        name: ObsErrorData/windNorthward   # After inflation step
      denominator:
        name: ObsError/windNorthward
  defer to post: true
