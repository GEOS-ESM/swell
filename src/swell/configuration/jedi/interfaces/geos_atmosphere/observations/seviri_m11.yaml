obs space:
  name: seviri_m11
  obsdatain:
    engine:
      type: H5File
      obsfile: '{{cycle_dir}}/seviri_m11.{{window_begin}}.nc4'
  obsdataout:
    engine:
      type: H5File
      obsfile: '{{cycle_dir}}/{{experiment_id}}.seviri_m11.{{window_begin}}.nc4'
  simulated variables: [brightnessTemperature]
  channels: &seviri_m11_channels 4-11
obs operator:
  name: CRTM
  Absorbers: [H2O,O3,CO2]
  obs options:
    Sensor_ID: seviri_m11
    EndianType: little_endian
    CoefficientPath: '{{crtm_coeff_dir}}'
obs bias:
  input file: '{{cycle_dir}}/seviri_m11.{{background_time}}.satbias.nc4'
  variational bc:
    predictors:
    - name: constant
    - name: lapse_rate
      order: 2
      tlapse: &seviri_m11_tlapse '{{cycle_dir}}/seviri_m11.{{background_time}}.tlapse.txt'
    - name: lapse_rate
      tlapse: *seviri_m11_tlapse
    - name: emissivity
    - name: scan_angle
      var_name: sensorScanPosition
      order: 4
    - name: scan_angle
      var_name: sensorScanPosition
      order: 3
    - name: scan_angle
      var_name: sensorScanPosition
      order: 2
    - name: scan_angle
      var_name: sensorScanPosition
obs filters:
#  Observation Range Sanity Check
- filter: Bounds Check
  filter variables:
  - name: brightnessTemperature
    channels: *seviri_m11_channels
  minvalue: 50.00001
  maxvalue: 449.99999
  action:
    name: reject
# Surface Check:use chn 2 and 3 over both sea and land while other IR chns only over sea
# ch2 and ch3 in GSI should be the original seviri ch5 and ch6
- filter: BlackList
  filter variables:
  - name: brightnessTemperature
    channels: 4,7-11
  where:
  - variable:
      name: GeoVaLs/water_area_fraction
    maxvalue: 0.99
# Do not use ch5,6 over snow
- filter: BlackList
  filter variables:
  - name: brightnessTemperature
    channels: *seviri_m11_channels
  where:
  - variable:
      name: GeoVaLs/surface_snow_area_fraction
    minvalue: 0.01
# Do not use ch5,6 over ice
- filter: BlackList
  filter variables:
  - name: brightnessTemperature
    channels: *seviri_m11_channels
  where:
  - variable:
      name: GeoVaLs/ice_area_fraction
    minvalue: 0.01
# Do not use over mixed surface
- filter: BlackList
  filter variables:
  - name: brightnessTemperature
    channels: *seviri_m11_channels
  where:
  - variable:
      name: GeoVaLs/land_area_fraction
    maxvalue: 0.99
  - variable:
      name: GeoVaLs/water_area_fraction
    maxvalue: 0.99
  - variable:
      name: GeoVaLs/ice_area_fraction
    maxvalue: 0.99
  - variable:
      name: GeoVaLs/surface_snow_area_fraction
    maxvalue: 0.99
# QC_terrain: If seviri and terrain height > 1km. do not use
- filter: Domain Check
  filter variables:
  - name: brightnessTemperature
    channels: *seviri_m11_channels
  where:
  - variable:
      name: GeoVaLs/surface_geopotential_height
    maxvalue: 1000.0
# Gross check
- filter: Background Check
  filter variables:
  - name: brightnessTemperature
    channels: *seviri_m11_channels
  absolute threshold: 2.0
  action:
    name: reject
#  Surface Jacobians Check
- filter: BlackList
  filter variables:
  - name: brightnessTemperature
    channels: *seviri_m11_channels
  action:
    name: inflate error
    inflation variable:
      name: ObsFunction/ObsErrorFactorSurfJacobianRad
      channels: *seviri_m11_channels
      options:
        channels: *seviri_m11_channels
        sensor: *Sensor_ID
        obserr_demisf: [0.01, 0.02, 0.02, 0.02, 0.02]
        obserr_dtempf: [0.50, 2.00, 3.00, 3.00, 5.00]
# Useflag Check
- filter: Bounds Check
  filter variables:
  - name: brightnessTemperature
    channels: *seviri_m11_channels
  test variables:
  - name: ObsFunction/ChannelUseflagCheckRad
    channels: *seviri_m11_channels
    options:
      channels: *seviri_m11_channels
      use_flag: [ -1,  1,  1, -1, -1, -1, -1, -1 ]
  minvalue: 1.0e-12
  action:
    name: reject
