diagnostics:

- data:
    type: IodaObsSpace
    datasets:

      - name: experiment
        filenames:
          - {{obs_path_file}}
        channels: &channels {{channels}}
        groups:
          - name: ObsValue
            variables: &variables {{simulated_variables}}
          - name: MetaData
          # Jedi
          - name: hofx
          - name: EffectiveQC
          - name: EffectiveError
          # Gsi
          - name: GsiHofX
          - name: GsiHofXBc
          - name: GsiEffectiveQC
          - name: GsiFinalObsError

  transforms:

    # Hofx differences
    # ----------------

    - transform: arithmetic
      new name: experiment::hofxDiff::${variable}
      equals: experiment::hofx::${variable}-experiment::GsiHofX::${variable}
      for:
        variable: *variables

    - transform: arithmetic
      new name: experiment::hofxDiffBc::${variable}
      equals: experiment::hofx::${variable}-experiment::GsiHofXBc::${variable}
      for:
        variable: *variables

    # Observation minus Hofx
    # ----------------------

    - transform: arithmetic
      new name: experiment::ObsValueMinusHofx::${variable}
      equals: experiment::ObsValue::${variable}-experiment::hofx::${variable}
      for:
        variable: *variables

    - transform: arithmetic
      new name: experiment::ObsValueMinusGsiHofX::${variable}
      equals: experiment::ObsValue::${variable}-experiment::GsiHofX::${variable}
      for:
        variable: *variables

    - transform: arithmetic
      new name: experiment::ObsValueMinusGsiHofXBc::${variable}
      equals: experiment::ObsValue::${variable}-experiment::GsiHofXBc::${variable}
      for:
        variable: *variables

    # Effective error that passed QC
    # ------------------------------

    - transform: accept where
      new name: experiment::EffectiveErrorPassedQc::${variable}
      starting field: experiment::EffectiveError::${variable}
      where:
        - experiment::EffectiveQC::${variable} == 0
      for:
        variable: *variables

    - transform: accept where
      new name: experiment::FinalObsErrorPassedQc::${variable}
      starting field: experiment::GsiFinalObsError::${variable}
      where:
        - experiment::GsiFinalObsError::${variable} > 0
      for:
        variable: *variables



#    # hofx that passed qz
#
#    # Generate hofx that passed QC for JEDI
#    - transform: accept where
#      new name: experiment::hofxPassedQc::${variable}
#      starting field: experiment::hofx::${variable}
#      where:
#        - experiment::EffectiveQC::${variable} == 0
#      for:
#        variable: *variables
#
#    # Generate GSI hofx that passed JEDI QC
#    - transform: accept where
#      new name: experiment::GsiHofXBcPassedQc::${variable}
#      starting field: experiment::GsiHofXBc::${variable}
#      where:
#        - experiment::EffectiveQC::${variable} == 0
#      for:
#        variable: *variables
#
#    # Generate omb that passed QC for JEDI
#    - transform: accept where
#      new name: experiment::ObsValueMinushofxPassedQc::${variable}
#      starting field: experiment::ObsValueMinusHofx::${variable}
#      where:
#        - experiment::EffectiveQC::${variable} == 0
#      for:
#        variable: *variables
#
#    # Generate omb that passed QC for GSI
#    - transform: accept where
#      new name: experiment::ObsValueMinusGsiHofXBcPassedQc::${variable}
#      starting field: experiment::ObsValueMinusGsiHofXBc::${variable}
#      where:
#        - experiment::EffectiveQC::${variable} == 0
#      for:
#        variable: *variables

  graphics:

    # Correlation scatter JEDI h(x) vs GSI h(x)
    # -----------------------------------------
    - batch figure:
        variables: *variables
        channels: *channels
      figure:
        layout: [1,1]
        title: 'JEDI h(x) vs. GSI h(x) | {{instrument_title}} | ${variable_title}'
        output name: '{{cycle_dir}}/eva/{{instrument}}/${variable}${channel}_a_hofx_vs_gsihofx.png'
      plots:
        - add_xlabel: 'GSI h(x)'
          add_ylabel: 'JEDI h(x)'
          add_grid:
          add_legend:
            loc: 'upper left'
          layers:
          - type: Scatter
            y:
              variable: experiment::hofx::${variable}
            x:
              variable: experiment::GsiHofX::${variable}
            channel: ${channel}
            markersize: 5
            color: 'blue'
            label: 'JEDI h(x) versus GSI h(x)'

    # Correlation scatter JEDI h(x) vs GSI h(x) BC
    # --------------------------------------------
    - batch figure:
        variables: *variables
        channels: *channels
      figure:
        layout: [1,1]
        title: 'JEDI h(x) vs. GSI h(x) | {{instrument_title}} | ${variable_title}'
        output name: '{{cycle_dir}}/eva/{{instrument}}/${variable}${channel}_b_hofx_vs_gsihofxbc.png'
      plots:
        - add_xlabel: 'GSI h(x)'
          add_ylabel: 'JEDI h(x)'
          add_grid:
          add_legend:
            loc: 'upper left'
          layers:
          - type: Scatter
            y:
              variable: experiment::hofx::${variable}
            x:
              variable: experiment::GsiHofXBc::${variable}
            channel: ${channel}
            markersize: 5
            color: 'blue'
            label: 'JEDI h(x) versus GSI h(x)'

    # Correlation scatter JEDI h(x) - GSI H(x) vs GSI h(x)
    # ----------------------------------------------------
    - batch figure:
        variables: *variables
        channels: *channels
      figure:
        layout: [1,1]
        title: 'JEDI h(x) vs. GSI h(x) | {{instrument_title}} | ${variable_title}'
        output name: '{{cycle_dir}}/eva/{{instrument}}/${variable}${channel}_c_hofxdiff_vs_gsihofx.png'
      plots:
        - add_xlabel: 'GSI h(x)'
          add_ylabel: 'JEDI h(x)'
          add_grid:
          add_legend:
            loc: 'upper left'
          layers:
          - type: Scatter
            y:
              variable: experiment::hofxDiff::${variable}
            x:
              variable: experiment::GsiHofX::${variable}
            channel: ${channel}
            markersize: 5
            color: 'blue'
            label: 'JEDI h(x) versus GSI h(x)'

    # Correlation scatter JEDI h(x) - GSI H(x) BC vs GSI h(x) BC
    # ----------------------------------------------------------
    - batch figure:
        variables: *variables
        channels: *channels
      figure:
        layout: [1,1]
        title: 'JEDI h(x) vs. GSI h(x) | {{instrument_title}} | ${variable_title}'
        output name: '{{cycle_dir}}/eva/{{instrument}}/${variable}${channel}_d_hofxdiffbc_vs_gsihofxbc.png'
      plots:
        - add_xlabel: 'GSI h(x)'
          add_ylabel: 'JEDI h(x)'
          add_grid:
          add_legend:
            loc: 'upper left'
          layers:
          - type: Scatter
            y:
              variable: experiment::hofxDiffBc::${variable}
            x:
              variable: experiment::GsiHofXBc::${variable}
            channel: ${channel}
            markersize: 5
            color: 'blue'
            label: 'JEDI h(x) versus GSI h(x)'
