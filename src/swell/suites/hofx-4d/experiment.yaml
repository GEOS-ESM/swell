# Experiment logistics
experiment_id: x0044-jedi
experiment_root: /discover/nobackup/${USER}/cylc_jedi_dev/experiments
platform_name: nccs_discover

# suite and executable
executable: fv3jedi_hofx.x
application_config: hofx4d

# suite configuration
suite:
  intial cylc point: 2020-12-15T00
  final cylc point: 2020-12-15T00
  runahead limit: PT24H
  suite name: hofx-4d
  scheduling:
    - task: Default
      platform: nccs-discover
      nodes: 1
      account: g0613
      execution_time_limit: PT10M
      qos: debug
      constraint: hasw
    - task: BuildJedi
      execution_time_limit: PT1H
      ntasks_per_node: 28
    - task: RunJediExecutable
      ntasks_per_node: 24

# data assimilation window
window_type: 4D
window_length: PT6H
window_offset: PT3H
analysis_forecast_window_offset: -PT3H
pseudo_model_tstep: PT1H

# backgrounds
backgrounds:
  background experiment: x0044    # Experiment that provides the background
  background source: file         # Could be file or model
  background schema: geos         # Schema for r2d2
  background frequency: PT1H      # Frequency of background if coming from file

# cycle times
initial_cycle_dt: 2020-12-15T12
final_cycle_dt: 2020-12-15T18

# resolution
horizontal_resolution: c360
npx: 361
npy: 361
npz: 72
npx_proc: 2
npy_proc: 2
processors:
  - $(npx_proc)
  - $(npy_proc)
  - 6

build jedi:
  existing build directory: /discover/nobackup/drholdaw/JediSwell/bundle/1.0.0/build-intel-impi-release-fv3/
  build options:
    - release    # release, debug, relwithdebug
  packages:
    - fv3-jedi
  bundle repos:
    - git url: https://github.com/jcsda/jedi-cmake
      project: jedicmake
      branch: develop
    - git url: https://github.com/jcsda/crtm
      project: crtm
      branch: develop
    - git url: https://github.com/jcsda/oops
      project: oops
      branch: develop
      clone on create: true
    - git url: https://github.com/jcsda/saber
      project: saber
      branch: develop
    - git url: https://github.com/jcsda/ioda
      project: ioda
      branch: develop
    - git url: https://github.com/jcsda/ufo
      project: ufo
      branch: develop
      clone on create: true
    - git url: https://github.com/jcsda/FMS
      project: fms
      branch: release-stable
    - git url: https://github.com/jcsda/GFDL_atmos_cubed_sphere
      project: fv3
      branch: release-stable
    - git url: https://github.com/jcsda/fv3-jedi-linearmodel
      project: fv3-jedi-lm
      branch: develop
    - git url: https://github.com/jcsda/femps
      project: femps
      branch: develop
    - git url: https://github.com/jcsda/fv3-jedi
      project: fv3-jedi
      branch: develop
      clone on create: true

# Fix file staging
# ----------------
STAGE:
  - copy_files:
      directories:
        - [$(bundle)/fv3-jedi/test/Data/fieldsets/*, $(stage_dir)/Data/fieldsets/]
        - [$(bundle)/fv3-jedi/test/Data/fv3files/*, $(stage_dir)/Data/fv3files/]
    link_files:
      directories:
        - [/discover/nobackup/drholdaw/JediData/GEOS_CRTM_Surface/geos.crtmsrf.$(horizontal_resolution).nc4, $(stage_dir)/Data/bkg/]

# JEDI Geometry
# -------------
GEOMETRY:
  fms initialization:
    namelist filename: '$(stage_dir)/Data/fv3files/fmsmpp.nml'
    field table filename: '$(stage_dir)/Data/fv3files/field_table_gmao'
  akbk: '$(stage_dir)/Data/fv3files/akbk$(npz).nc4'
  layout: [$(npx_proc),$(npy_proc)]
  npx: $(npx)
  npy: $(npy)
  npz: $(npz)
  fieldsets:
    - fieldset: '$(stage_dir)/Data/fieldsets/dynamics.yaml'
    - fieldset: '$(stage_dir)/Data/fieldsets/ufo.yaml'

# JEDI Background
# ---------------
BACKGROUND:
  datetime: '{{local_background_time}}'
  filetype: cube sphere history
  provider: geos
  datapath: ''
  filenames: [$(run_dir)/%yyyy%mm%dd.%hh%MM%ss.bkg.nc4,
              $(stage_dir)/Data/bkg/geos.crtmsrf.$(horizontal_resolution).nc4]
  state variables: [u,v,ua,va,t,delp,q,qi,ql,o3ppmv,phis,
                    qls,qcn,cfcn,frocean,frland,varflt,ustar,bstar,
                    zpbl,cm,ct,cq,kcbl,tsm,khl,khu,frlake,frseaice,vtype,
                    stype,vfrac,sheleg,ts,soilt,soilm,u10m,v10m]
  filename: $(run_dir)/$(valid_date).$(file_type).nc4  # R2D2

# JEDI Forecast model
# -------------------
MODEL:
  name: PSEUDO
  tstep: '$(pseudo_model_tstep)'
  filetype: cube sphere history
  provider: geos
  datapath: ''
  filenames: [$(run_dir)/%yyyy%mm%dd.%hh%MM%ss.bkg.nc4,
              $(stage_dir)/Data/bkg/geos.crtmsrf.$(horizontal_resolution).nc4]
  model variables: [u,v,ua,va,t,delp,q,qi,ql,o3ppmv,phis,qls,qcn,cfcn,frocean,frland,varflt,ustar,
                    bstar,zpbl,cm,ct,cq,kcbl,tsm,khl,khu,frlake,frseaice,vtype,stype,vfrac,sheleg,
                    ts,soilt,soilm,u10m,v10m]

# R2D2 schema
# -----------
R2D2:
  fetch:
    an:
      - file_type: [bkg]
        user_date_format: '%Y%m%d.%H%M%S'
    fc:
      - file_type: [bkg]
        user_date_format: '%Y%m%d.%H%M%S'
    bc:
      - file_type: satbias
        target_file: $(run_dir)/$(obs_type).$(date).$(file_type).nc4
      - file_type: tlapse
        target_file: $(run_dir)/$(obs_type).$(date).$(file_type).txt
  store:
    fc:
      - file_type: [bkg]
        user_date_format: '%Y%m%d.%H%M%S'


# Observations
# ------------
obs_experiment: x0044

OBSERVATIONS:
  - yaml::$(bundle)/ufo/ewok/jedi-geos/aircraft.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/airs_aqua.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/amsua_aqua.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/amsua_metop-a.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/amsua_metop-b.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/amsua_metop-c.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/amsua_n15.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/amsua_n18.yaml
  - yaml::$(bundle)/ufo/ewok/jedi-geos/amsua_n19.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/cris-fsr_n20.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/cris-fsr_npp.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/iasi_metop-a.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/iasi_metop-b.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/mhs_metop-b.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/mhs_metop-c.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/mhs_n19.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/rass_tv.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/satwind.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/sfc.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/sfcship.yaml
  #- yaml::$(bundle)/ufo/ewok/jedi-geos/vadwind.yaml
